name: Diff Outputs

on: workflow_dispatch

jobs:
  diff-outputs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure git author
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Check for differences in built assets
        run: |
          # Exit the script if any command fails
          set -e

          clean_dist() {
            echo "Deleting all dist/cache directories..."

            # Find and delete all dist directories, except under node_modules
            find . -path "*/node_modules" -prune -o \
              -type d -name "dist" -prune \
              -exec rm -rf {} \; \
              -exec echo "Deleted: {}" \;

            # Find and delete all rollup caches
            find . -type d -name ".rollup.cache" -prune -exec rm -rf {} \; -exec echo "Deleted: {}" \;
          }

          clean_install_and_build() {
            echo "Removing existing node_modules..."
            find . -type d -name "node_modules" -prune -exec rm -rf {} \; -exec echo "Deleted: {}" \;

            echo "Installing deps and building..."
            npm install
          }

          # Unignore dist directories and stage them to commit later
          sed -i '/\<dist\>/d' .gitignore
          git add -A

          echo "Checking out master..."
          git fetch --depth=1 origin master
          git checkout master
          clean_install_and_build

          echo "Checking out the current branch..."
          git checkout -

          # Commit the previously staged changes
          git commit --no-verify -m "unignore dist directories"

          echo "Committing built assets from master..."
          git add -A && git commit --no-verify -m "before (master)"

          echo "Building this branch..."
          clean_dist
          clean_install_and_build
          git add -A

          echo "Checking for differences in built assets..."
          if git diff --cached --exit-code; then
            echo "‚úÖ No differences found in built assets!"
          else
            echo "‚ö†Ô∏è Differences found in built assets! This indicates that the compiled outputs in this branch don't match what master produces."
            echo "üëâ Please investigate the differences above to see if they are expected."
            exit 1
          fi
